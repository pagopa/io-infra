<!--
    API Management Policy: Get Cached User Session

    This policy implements cached session retrieval with the following behavior:
    - Inbound: 
        1. Validates request comes from internal host
        2. Validates X-Session-Token header presence and format (at least 64 chars)
        3. Looks up the session token in APIM internal cache
        4. Returns 200 with base64-encoded user data if found
        5. Returns 204 No Content if not found in cache
    - Error: Returns ProblemJson responses as per OpenAPI spec

    Expected responses:
    - 200: Session data retrieved successfully (base64-encoded)
    - 400: Bad request (missing or invalid token)
    - 401: Unauthorized (request from non-internal host)
    - 500: Internal server error
-->
<policies>
    <inbound>
        <base />
        
        <!-- Verify request comes from internal host only -->
        <choose>
            <when condition="@(!context.Request.OriginalUrl.Host.Equals("{{platform-api-gateway-hostname-internal}}", StringComparison.OrdinalIgnoreCase))">
                <return-response>
                    <set-status code="401" reason="Unauthorized" />
                </return-response>
            </when>
        </choose>
        
        <!-- Extract session token from header -->
        <set-variable name="sessionToken" value="@(context.Request.Headers.GetValueOrDefault("X-Session-Token", ""))" />
        
        <!-- Validate token presence -->
        <choose>
            <when condition="@(string.IsNullOrEmpty(context.Variables.GetValueOrDefault<string>("sessionToken")))">
                <return-response>
                    <set-status code="400" reason="Bad Request" />
                    <set-header name="Content-Type" exists-action="override">
                        <value>application/json</value>
                    </set-header>
                    <set-body>@{
                        return new JObject(
                            new JProperty("type", "https://developer.pagopa.it/io/problems/bad-request"),
                            new JProperty("title", "Bad Request"),
                            new JProperty("status", 400),
                            new JProperty("detail", "Missing required header: X-Session-Token"),
                            new JProperty("instance", context.Request.Url.Path)
                        ).ToString();
                    }</set-body>
                </return-response>
            </when>
        </choose>
        
        <!-- Validate token length (must be at least 64 characters) -->
        <choose>
            <when condition="@(context.Variables.GetValueOrDefault<string>("sessionToken").Length < 64)">
                <return-response>
                    <set-status code="400" reason="Bad Request" />
                    <set-header name="Content-Type" exists-action="override">
                        <value>application/json</value>
                    </set-header>
                    <set-body>@{
                        return new JObject(
                            new JProperty("type", "https://developer.pagopa.it/io/problems/bad-request"),
                            new JProperty("title", "Bad Request"),
                            new JProperty("status", 400),
                            new JProperty("detail", "Invalid X-Session-Token: must be at least 64 characters"),
                            new JProperty("instance", context.Request.Url.Path)
                        ).ToString();
                    }</set-body>
                </return-response>
            </when>
        </choose>
        
        <!-- Lookup session token in APIM internal cache -->
        <cache-lookup-value key="@("{{session-token-cache-prefix}}" + context.Variables.GetValueOrDefault<string>("sessionToken"))" variable-name="cachedUserData" caching-type="internal" />
        
        <choose>
            <when condition="@(context.Variables.ContainsKey("cachedUserData"))">
                <!-- Cache HIT: return base64-encoded user data -->
                <return-response>
                    <set-status code="200" reason="OK" />
                    <set-header name="Content-Type" exists-action="override">
                        <value>text/plain</value>
                    </set-header>
                    <set-body>@((string)context.Variables["cachedUserData"])</set-body>
                </return-response>
            </when>
            <otherwise>
                <!-- Cache MISS: return 204 No Content -->
                <return-response>
                    <set-status code="204" reason="No Content" />
                </return-response>
            </otherwise>
        </choose>
    </inbound>
    <backend>
        <base />
    </backend>
    <outbound>
        <base />
    </outbound>
    <on-error>
        <base />
        <return-response>
            <set-status code="500" reason="Internal Server Error" />
            <set-header name="Content-Type" exists-action="override">
                <value>application/json</value>
            </set-header>
            <set-body>@{
                return new JObject(
                    new JProperty("type", "https://developer.pagopa.it/io/problems/internal-error"),
                    new JProperty("title", "Internal Server Error"),
                    new JProperty("status", 500),
                    new JProperty("detail", "An unexpected error occurred while processing the request"),
                    new JProperty("instance", context.Request.Url.Path)
                ).ToString();
            }</set-body>
        </return-response>
    </on-error>
</policies>
